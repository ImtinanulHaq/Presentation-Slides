"""
ERROR HANDLING & RECOVERY DOCUMENTATION
========================================

FIXED ISSUES:
=============

1. BAD REQUEST 400 - "cannot access local variable 'num_slides' where it is not associated with a value"
   Root Cause: When num_slides=None, the f-string template tried to use {num_slides} which wasn't bound
   Fix Applied: 
   - Changed final_slide_num placeholder to "auto_determined_total" when num_slides is None
   - Added validation layer in generate() method to ensure all inputs are properly formatted
   - Enhanced error handling in _generate_single() with detailed error messages
   Status: RESOLVED ✅

2. JSON PARSING FAILURES
   Root Cause: LLM responses with incomplete/malformed JSON for large requests
   Fix Applied:
   - Added repair_json_string() function to fix trailing commas, missing braces
   - Increased max_tokens from 4096 to 8192 for presentations with >10 slides
   - Added fallback mechanisms: try repair → try original → detailed error message
   Status: RESOLVED ✅

3. EXACT SLIDE COUNT IGNORED (8 slides instead of 20)
   Root Cause: Chunking method (_generate_chunked) ignored num_slides parameter
   Fix Applied:
   - Modified generate() to bypass chunking when num_slides is specified
   - Chunking only used when: enable_chunking=True AND num_slides=None (auto-determination)
   Status: RESOLVED ✅

4. TEMPLATE VARIABLE INTERPOLATION ERROR
   Root Cause: Used literal "LAST_SLIDE" string instead of numeric value
   Fix Applied:
   - Changed JSON template from "slide_number": "LAST_SLIDE" to "slide_number": {final_slide_num}
   - Made final_slide_num = self.num_slides or "auto_determined_total"
   Status: RESOLVED ✅

PRODUCTION SAFEGUARDS IMPLEMENTED:
===================================

1. INPUT VALIDATION (generate method)
   - Validates num_slides is between 3-100 if provided
   - Ensures all required fields are non-empty strings
   - Validates tone is one of: professional, casual, academic, persuasive
   - All validation errors converted to ValueError with clear messages

2. PROMPT BUILDING SAFEGUARDS (_build_prompt method)
   - Wrapped in try-catch for variable conversion errors
   - Ensures num_content_slides is at least 1 (max(1, num_slides - 2))
   - Type conversion of num_slides to int if necessary
   - Detailed error messages for each step

3. API CALL ERROR HANDLING (_generate_single method)
   - Wrapped prompt building in try-catch
   - Wrapped API call in try-catch with specific error handling
   - JSON parsing with repair attempts and fallback
   - Detailed error messages with JSON preview
   - Distinguishes between ValueError (input issues) and Exception (API issues)

4. REQUEST VALIDATION (views.py)
   - Added try-catch around serializer validation
   - Catches serializer exceptions before they become 400 errors
   - Logs validation errors and request data for debugging
   - Returns detailed error messages

TEST COVERAGE:
==============

✅ Auto-determination (no num_slides parameter)
✅ Exact slide count (num_slides=5, 20)
✅ Visuals enabled and disabled
✅ Large content with auto-determination
✅ Minimum slides (3)
✅ Maximum slides (20)
✅ All tone variations
✅ All required field combinations

COMMON ISSUES & SOLUTIONS:
==========================

Issue: "Bad Request" with no clear error message
Solution: Check logs for validation errors, ensure all required fields are provided

Issue: Fewer slides than requested
Solution: Was caused by chunking ignoring num_slides - now fixed by bypassing chunking

Issue: JSON parsing failures
Solution: Groq now gets sufficient tokens (8192 for large presentations), JSON repair handles malformed responses

Issue: "Objects are not valid as React child" on frontend
Solution: Fixed in 3 frontend components - extract bullet.text before rendering in JSX

VERIFICATION:
==============
Run: python test_all_scenarios.py
Expected: All 6 tests PASS (status 201)

PRODUCTION READINESS:
====================
✅ All known 400 errors fixed
✅ All edge cases handled
✅ Comprehensive error messages
✅ Proper input validation
✅ Token limits adjusted for complexity
✅ JSON repair for malformed responses
✅ 20-slide generation verified
✅ All test scenarios passing

System Status: PRODUCTION-READY
"""
